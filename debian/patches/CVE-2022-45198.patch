From c9f1b35e981075110a23487a8d4a6cbb59a588ea Mon Sep 17 00:00:00 2001
From: Andrew Murray <radarhere@users.noreply.github.com>
Date: Thu, 30 Jun 2022 12:47:35 +1000
Subject: [PATCH] Added GIF decompression bomb check

---
 Tests/images/decompression_bomb_extents.gif | Bin 0 -> 368 bytes
 Tests/test_decompression_bomb.py            |   5 +++++
 src/PIL/GifImagePlugin.py                   |   1 +
 3 files changed, 6 insertions(+)
 create mode 100644 Tests/images/decompression_bomb_extents.gif

--- pillow-7.0.0.orig/Tests/test_decompression_bomb.py
+++ pillow-7.0.0/Tests/test_decompression_bomb.py
@@ -58,6 +58,11 @@ class TestDecompressionBomb(PillowTestCa
         with self.assertRaises(Image.DecompressionBombError):
             Image.open("Tests/images/decompression_bomb.gif")
 
+    def test_exception_gif_extents(self):
+        with Image.open("Tests/images/decompression_bomb_extents.gif") as im:
+            with self.assertRaises(Image.DecompressionBombError):
+                im.seek(1)
+
 
 class TestDecompressionCrop(PillowTestCase):
     def setUp(self):
--- pillow-7.0.0.orig/src/PIL/GifImagePlugin.py
+++ pillow-7.0.0/src/PIL/GifImagePlugin.py
@@ -151,7 +151,6 @@ class GifImageFile(ImageFile.ImageFile):
 
         if frame != self.__frame + 1:
             raise ValueError("cannot seek to frame %d" % frame)
-        self.__frame = frame
 
         self.tile = []
 
@@ -171,6 +170,7 @@ class GifImageFile(ImageFile.ImageFile):
         self.palette = copy(self.global_palette)
 
         info = {}
+        interlace = None
         while True:
 
             s = self.fp.read(1)
@@ -235,6 +235,7 @@ class GifImageFile(ImageFile.ImageFile):
                 x1, y1 = x0 + i16(s[4:]), y0 + i16(s[6:])
                 if x1 > self.size[0] or y1 > self.size[1]:
                     self._size = max(x1, self.size[0]), max(y1, self.size[1])
+                    Image._decompression_bomb_check(self._size)
                 self.dispose_extent = x0, y0, x1, y1
                 flags = i8(s[8])
 
@@ -256,6 +257,11 @@ class GifImageFile(ImageFile.ImageFile):
                 pass
                 # raise IOError, "illegal GIF tag `%x`" % i8(s)
 
+        if interlace is None:
+            raise EOFError
+
+        self.__frame = frame
+
         try:
             if self.disposal_method < 2:
                 # do not dispose or none specified
