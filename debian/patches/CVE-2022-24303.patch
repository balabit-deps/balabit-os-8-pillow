From 427221ef5f19157001bf8b1ad7cfe0b905ca8c26 Mon Sep 17 00:00:00 2001
From: Andrew Murray <radarhere@users.noreply.github.com>
Date: Mon, 17 Jan 2022 08:59:17 +1100
Subject: [PATCH] In show_file, use os.remove to remove temporary images

---
 src/PIL/ImageShow.py | 68 ++++++++++++++++++++++++++++----------------
 1 file changed, 44 insertions(+), 24 deletions(-)

--- pillow-7.0.0.orig/src/PIL/ImageShow.py
+++ pillow-7.0.0/src/PIL/ImageShow.py
@@ -15,7 +15,6 @@ import os
 import shutil
 import subprocess
 import sys
-import tempfile
 from shlex import quote
 
 from PIL import Image
@@ -128,16 +127,15 @@ elif sys.platform == "darwin":
 
         def show_file(self, file, **options):
             """Display given file"""
-            fd, path = tempfile.mkstemp()
-            with os.fdopen(fd, "w") as f:
-                f.write(file)
-            with open(path, "r") as f:
-                subprocess.Popen(
-                    ["im=$(cat); open -a Preview.app $im; sleep 20; rm -f $im"],
-                    shell=True,
-                    stdin=f,
-                )
-            os.remove(path)
+            subprocess.call(["open", "-a", "Preview.app", file])
+            subprocess.Popen(
+                [
+                    sys.executable,
+                    "-c",
+                    "import os, sys, time;time.sleep(20);os.remove(sys.argv[1])",
+                    file,
+                ]
+            )
             return 1
 
     register(MacViewer)
@@ -154,19 +152,6 @@ else:
             command = self.get_command_ex(file, **options)[0]
             return "({} {}; rm -f {})&".format(command, quote(file), quote(file))
 
-        def show_file(self, file, **options):
-            """Display given file"""
-            fd, path = tempfile.mkstemp()
-            with os.fdopen(fd, "w") as f:
-                f.write(file)
-            with open(path, "r") as f:
-                command = self.get_command_ex(file, **options)[0]
-                subprocess.Popen(
-                    ["im=$(cat);" + command + " $im; rm -f $im"], shell=True, stdin=f
-                )
-            os.remove(path)
-            return 1
-
     # implementations
 
     class DisplayViewer(UnixViewer):
@@ -174,6 +159,15 @@ else:
             command = executable = "display"
             return command, executable
 
+        def show_file(self, file, **options):
+            args = ["display"]
+            if "title" in options:
+                args += ["-name", options["title"]]
+            args.append(file)
+
+            subprocess.Popen(args)
+            return 1
+
     if shutil.which("display"):
         register(DisplayViewer)
 
@@ -182,6 +176,10 @@ else:
             command = executable = "eog"
             return command, executable
 
+        def show_file(self, file, **options):
+            subprocess.Popen(["eog", "-n", file])
+            return 1
+
     if shutil.which("eog"):
         register(EogViewer)
 
@@ -194,6 +192,15 @@ else:
                 command += " -name %s" % quote(title)
             return command, executable
 
+        def show_file(self, file, **options):
+            args = ["xv"]
+            if "title" in options:
+                args += ["-name", options["title"]]
+            args.append(file)
+
+            subprocess.Popen(args)
+            return 1
+
     if shutil.which("xv"):
         register(XVViewer)
 
