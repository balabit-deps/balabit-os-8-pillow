From 2a93aba5cfcf6e241ab4f9392c13e3b74032c061 Mon Sep 17 00:00:00 2001
From: Andrew Murray <radarhere@users.noreply.github.com>
Date: Thu, 22 Feb 2024 18:56:26 +1100
Subject: [PATCH] Use strncpy to avoid buffer overflow

Index: pillow-7.0.0/Tests/test_imagecms.py
===================================================================
--- pillow-7.0.0.orig/Tests/test_imagecms.py
+++ pillow-7.0.0/Tests/test_imagecms.py
@@ -605,3 +605,7 @@ class TestImageCms(PillowTestCase):
                     self.assert_image_equal(
                         test_image.convert(dst_format[2]), reference_image
                     )
+
+    def test_long_modes():
+        p = ImageCms.getOpenProfile("Tests/icc/sGrey-v2-nano.icc")
+        ImageCms.buildTransform(p, p, "ABCDEFGHI", "ABCDEFGHI")
Index: pillow-7.0.0/src/_imagingcms.c
===================================================================
--- pillow-7.0.0.orig/src/_imagingcms.c
+++ pillow-7.0.0/src/_imagingcms.c
@@ -203,8 +203,8 @@ cms_transform_new(cmsHTRANSFORM transfor
 
     self->transform = transform;
 
-    strcpy(self->mode_in, mode_in);
-    strcpy(self->mode_out, mode_out);
+    strncpy(self->mode_in, mode_in, 8);
+    strncpy(self->mode_out, mode_out, 8);
 
     return (PyObject*) self;
 }
@@ -277,8 +277,8 @@ findLCMStype(char* PILmode)
     }
 
     else {
-        /* take a wild guess... but you probably should fail instead. */
-        return TYPE_GRAY_8; /* so there's no buffer overrun... */
+        /* take a wild guess */
+        return TYPE_GRAY_8;
     }
 }
 
