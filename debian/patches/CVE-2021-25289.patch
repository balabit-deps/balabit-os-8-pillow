Backport of:

From 3fee28eb9479bf7d59e0fa08068f9cc4a6e2f04c Mon Sep 17 00:00:00 2001
From: Eric Soroos <eric-github@soroos.net>
Date: Sun, 3 Jan 2021 21:35:32 +0100
Subject: [PATCH] Incorrect error code checking in TiffDecode.c

* since Pillow 8.1.0
* CVE-2021-25289
---
 ...-0e16d3bfb83be87356d026d66919deaefca44dac.tif | Bin 0 -> 4567 bytes
 ...-1152ec2d1a1a71395b6f2ce6721c38924d025bf3.tif | Bin 0 -> 4221 bytes
 Tests/test_tiff_crashes.py                       |   2 ++
 src/libImaging/TiffDecode.c                      |   3 +--
 4 files changed, 3 insertions(+), 2 deletions(-)
 create mode 100644 Tests/images/crash-0e16d3bfb83be87356d026d66919deaefca44dac.tif
 create mode 100644 Tests/images/crash-1152ec2d1a1a71395b6f2ce6721c38924d025bf3.tif

--- a/src/libImaging/TiffDecode.c
+++ b/src/libImaging/TiffDecode.c
@@ -239,7 +239,7 @@ int _decodeStripYCbCr(Imaging im, Imagin
         img.row_offset = state->y; 
         rows_to_read = min(rows_per_strip, img.height - state->y);
 
-        if (TIFFRGBAImageGet(&img, (UINT32 *)state->buffer, img.width, rows_to_read) == -1) {
+        if (!TIFFRGBAImageGet(&img, (UINT32 *)state->buffer, img.width, rows_to_read)) {
             TRACE(("Decode Error, y: %d\n", state->y ));
             state->errcode = IMAGING_CODEC_BROKEN;
             goto decodeycbcr_err;
