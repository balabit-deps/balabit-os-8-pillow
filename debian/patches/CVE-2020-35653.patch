Backport of:

From 2f409261eb1228e166868f8f0b5da5cda52e55bf Mon Sep 17 00:00:00 2001
From: Eric Soroos <eric-github@soroos.net>
Date: Thu, 17 Dec 2020 00:17:53 +0100
Subject: [PATCH] Fix for CVE CVE-2020-35655 - Read Overflow in PCX Decoding.

* Don't trust the image to specify a buffer size
---
 Tests/images/ossfuzz-4836216264589312.pcx | Bin 0 -> 129 bytes
 Tests/test_image.py                       |  27 ++++++++++++----------
 src/PIL/PcxImagePlugin.py                 |   9 ++++++--
 3 files changed, 22 insertions(+), 14 deletions(-)
 create mode 100644 Tests/images/ossfuzz-4836216264589312.pcx

--- a/src/PIL/PcxImagePlugin.py
+++ b/src/PIL/PcxImagePlugin.py
@@ -64,13 +64,13 @@ class PcxImageFile(ImageFile.ImageFile):
         version = i8(s[1])
         bits = i8(s[3])
         planes = i8(s[65])
-        stride = i16(s, 66)
+        ignored_stride = i16(s, 66)
         logger.debug(
             "PCX version %s, bits %s, planes %s, stride %s",
             version,
             bits,
             planes,
-            stride,
+            ignored_stride,
         )
 
         self.info["dpi"] = i16(s, 12), i16(s, 14)
@@ -108,6 +108,11 @@ class PcxImageFile(ImageFile.ImageFile):
         self.mode = mode
         self._size = bbox[2] - bbox[0], bbox[3] - bbox[1]
 
+        # don't trust the passed in stride. Calculate for ourselves.
+        # CVE-2020-35655
+        stride = (self._size[0] * bits + 7) // 8
+        stride += stride % 2
+
         bbox = (0, 0) + self.size
         logger.debug("size: %sx%s", *self.size)
 
