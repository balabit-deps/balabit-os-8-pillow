Backport of:

From 1fe1bb49c452b0318cad12ea9d97c3bef188e9a7 Mon Sep 17 00:00:00 2001
From: Andrew Murray <radarhere@users.noreply.github.com>
Date: Fri, 30 Jun 2023 23:32:26 +1000
Subject: [PATCH] Added ImageFont.MAX_STRING_LENGTH

---
 Tests/test_imagefont.py      | 19 +++++++++++++++++++
 docs/reference/ImageFont.rst | 18 ++++++++++++++++++
 docs/releasenotes/10.0.0.rst | 12 ++++++++++++
 src/PIL/ImageFont.py         | 15 +++++++++++++++
 4 files changed, 64 insertions(+)

#diff --git a/docs/releasenotes/10.0.0.rst b/docs/releasenotes/10.0.0.rst
#index 94ff04d46a2..4cd6293229a 100644
#--- a/docs/releasenotes/10.0.0.rst
#+++ b/docs/releasenotes/10.0.0.rst
#@@ -170,6 +170,18 @@ now been fixed.
# This effectively dates to the PIL fork, since problem images would still have
# been processed before Pillow started checking for decompression bombs.
# 
#+Added ImageFont.MAX_STRING_LENGTH
#+^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
#+
#+To protect against potential DOS attacks when using arbitrary strings as text
#+input, Pillow will now raise a ``ValueError`` if the number of characters
#+passed into ImageFont methods is over a certain limit,
#+:py:data:`PIL.ImageFont.MAX_STRING_LENGTH`.
#+
#+This threshold can be changed by setting
#+:py:data:`PIL.ImageFont.MAX_STRING_LENGTH`. It can be disabled by setting
#+``ImageFont.MAX_STRING_LENGTH = None``.
#+
# Other Changes
# =============
# 
--- a/Tests/test_imagefont.py
+++ b/Tests/test_imagefont.py
@@ -7,6 +7,7 @@ import sys
 import unittest
 from io import BytesIO
 
+import pytest
 from PIL import Image, ImageDraw, ImageFont, features
 
 from .helper import PillowTestCase, is_pypy, is_win32
@@ -744,6 +745,26 @@ class TestImageFont(PillowTestCase):
         font.set_variation_by_axes([100])
         _check_text(font, "Tests/images/variation_tiny_axes.png", 32.5)
 
+    def test_too_many_characters(self):
+        font = self.get_font()
+
+        with pytest.raises(ValueError):
+            font.getsize("A" * 1000001)
+        with pytest.raises(ValueError):
+            font.getsize_multiline("A" * 1000001)
+        with pytest.raises(ValueError):
+            font.getoffset("A" * 1000001)
+        with pytest.raises(ValueError):
+            font.getmask2("A" * 1000001)
+
+        transposed_font = ImageFont.TransposedFont(font)
+        with pytest.raises(ValueError):
+            transposed_font.getsize("A" * 1000001)
+
+        default_font = ImageFont.load_default()
+        with pytest.raises(ValueError):
+            default_font.getsize("A" * 1000001)
+
 
 @unittest.skipUnless(HAS_RAQM, "Raqm not Available")
 class TestImageFont_RaqmLayout(TestImageFont):
--- a/docs/reference/ImageFont.rst
+++ b/docs/reference/ImageFont.rst
@@ -17,6 +17,15 @@ OpenType fonts (as well as other font fo
 library). For earlier versions, TrueType support is only available as part of
 the imToolkit package
 
+.. warning::
+    To protect against potential DOS attacks when using arbitrary strings as
+    text input, Pillow will raise a ``ValueError`` if the number of characters
+    is over a certain limit, :py:data:`MAX_STRING_LENGTH`.
+
+    This threshold can be changed by setting
+    :py:data:`MAX_STRING_LENGTH`. It can be disabled by setting
+    ``ImageFont.MAX_STRING_LENGTH = None``.
+
 Example
 -------
 
@@ -55,3 +64,12 @@ Methods
 
 .. autoclass:: PIL.ImageFont.TransposedFont
     :members:
+
+Constants
+---------
+
+.. data:: MAX_STRING_LENGTH
+
+    Set to 1,000,000, to protect against potential DOS attacks. Pillow will
+    raise a ``ValueError`` if the number of characters is over this limit. The
+    check can be disabled by setting ``ImageFont.MAX_STRING_LENGTH = None``.
--- a/src/PIL/ImageFont.py
+++ b/src/PIL/ImageFont.py
@@ -43,12 +43,21 @@ class _imagingft_not_installed:
         raise ImportError("The _imagingft C module is not installed")
 
 
+MAX_STRING_LENGTH = 1000000
+
+
 try:
     from . import _imagingft as core
 except ImportError:
     core = _imagingft_not_installed()
 
 
+def _string_length_check(text):
+    if MAX_STRING_LENGTH is not None and len(text) > MAX_STRING_LENGTH:
+        msg = "too many characters in string"
+        raise ValueError(msg)
+
+
 # FIXME: add support for pilfont2 format (see FontFile.py)
 
 # --------------------------------------------------------------------
@@ -119,6 +128,7 @@ class ImageFont:
 
         :return: (width, height)
         """
+        _string_length_check(text)
         return self.font.getsize(text)
 
     def getmask(self, text, mode="", *args, **kwargs):
@@ -253,6 +263,7 @@ class FreeTypeFont:
 
         :return: (width, height)
         """
+        _string_length_check(text)
         size, offset = self.font.getsize(text, direction, features, language)
         return (
             size[0] + stroke_width * 2 + offset[0],
@@ -308,6 +319,7 @@ class FreeTypeFont:
 
         :return: (width, height)
         """
+        _string_length_check(text)
         max_width = 0
         lines = self._multiline_split(text)
         line_spacing = self.getsize("A", stroke_width=stroke_width)[1] + spacing
@@ -329,6 +341,7 @@ class FreeTypeFont:
 
         :return: A tuple of the x and y offset
         """
+        _string_length_check(text)
         return self.font.getsize(text)[1]
 
     def getmask(
@@ -462,6 +475,7 @@ class FreeTypeFont:
                  :py:mod:`PIL.Image.core` interface module, and the text offset, the
                  gap between the starting coordinate and the first marking
         """
+        _string_length_check(text)
         size, offset = self.font.getsize(text, direction, features, language)
         size = size[0] + stroke_width * 2, size[1] + stroke_width * 2
         im = fill("L", size, 0)
@@ -561,6 +575,7 @@ class TransposedFont:
         self.orientation = orientation  # any 'transpose' argument, or None
 
     def getsize(self, text, *args, **kwargs):
+        _string_length_check(text)
         w, h = self.font.getsize(text)
         if self.orientation in (Image.ROTATE_90, Image.ROTATE_270):
             return h, w
